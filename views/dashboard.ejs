<% include ./partials/navbar %>
<% include ./partials/footer %>


  <style>
    body {
        background: #ececec;
    }
    /*Hidden class for adding and removing*/
    .lds-dual-ring.hidden {
        display: none;
    }
 
    /*Add an overlay to the entire page blocking any further presses to buttons or other elements.*/
    .overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100vh;
        background: rgba(0,0,0,.8);
        z-index: 999;
        opacity: 1;
        transition: all 0.5s;
    }
     
  </style>


  <script>
    $(document).ready(()=>{
      $('#spinner').hide();
      $('#spinnerPldForm').hide();
        $.ajax({
            url : '/users/getpldForm',
            type: 'get',
            dataType :'json',
            beforeSend: function () { // Before we send the request, remove the .hidden class from the spinner and default to inline-block.
              //$('#loader').removeClass('hidden');
              $('#htmlTable').empty();
               $('#spinnerPldForm').show();
            },
        })
        .done((response)=>{
            console.log('response  '+JSON.stringify(response));
            if(response.length > 0)
            {
              let htmlTable = '';
              htmlTable += '<thead><tr>';
              htmlTable += '<th>Serial </th>';
              htmlTable += '<th>Project Name</th>';
              htmlTable += '<th>Form Link</th>';
              htmlTable += '<th>Sent Date Time</th>';
              htmlTable += '<th>View Responses</th>';
              htmlTable += '</tr></thead>';
              htmlTable += '<tbody>';
              let i=1;
              response.forEach((eachRecord) => {
                console.log('type  : '+typeof(eachRecord.sentdate));
                let dateTime = new Date(eachRecord.sentdate);
                dateTime.setHours(dateTime.getHours() + 5);
                dateTime.setMinutes(dateTime.getMinutes() + 30);
                dateTime =  dateTime.toLocaleString();
                console.log('dateTime  : '+dateTime);
                htmlTable += '<tr>';
                htmlTable += '<td>'+i+' </td>';
                htmlTable += '<td>'+eachRecord.projectname+' </td>';
                htmlTable += '<td><a class="btn btn-primary" style="color:white;" href="'+eachRecord.pldformurl+'" target="_blank" >Click Here</a></td>';
                htmlTable += '<td>'+dateTime+' </td>';
                htmlTable += '<td><a class="btn btn-primary responseModalAnchorId" id="'+eachRecord.pldformid+'"  style="color:white;" href="#"  >View Responses</a> </td>';
                htmlTable += '</tr>';
                i++;
              })
              htmlTable += '</tbody>';
              $('#spinnerPldForm').hide();
              $('#pldTable').html(htmlTable);

              $("a.responseModalAnchorId").click(function(e){
                e.preventDefault();
                console.log('Sharma');
                $('#responsesModal').modal('show');
                let formId = $(this).attr('id');
               
                $.ajax({
                    url : '/users/viewResponses',
                    type: 'get',
                    data : {
                      pldformid : formId
                    },
                    dataType : 'json',
                    beforeSend: function () { // Before we send the request, remove the .hidden class from the spinner and default to inline-block.
                      
                      $('#responsesTable').empty();
                       $('#spinner').show();
                    },
                })
                .done(function(response){
                    console.log('response  '+JSON.stringify(response));

                    let htmlResponsesTable = '';
                    if(response.length > 0)
                    {
                          htmlResponsesTable += '<thead><tr>';
                          htmlResponsesTable += '<th>Serial </th>';
                          htmlResponsesTable += '<th>Response Name</th>';
                          htmlResponsesTable += '<th>Response Date Time</th>';
                          htmlResponsesTable += '<th>Preivew</th>';
                          htmlResponsesTable += '</tr></thead>';
                          htmlResponsesTable += '<tbody>';
                          let i=1;
                          response.forEach((eachRecord)=> {
                              console.log('type  : '+typeof(eachRecord.createddate));
                              let dateTime = new Date(eachRecord.createddate);
                              dateTime.setHours(dateTime.getHours() + 5);
                              dateTime.setMinutes(dateTime.getMinutes() + 30);
                              dateTime =  dateTime.toLocaleString();
                              console.log('dateTime  : '+dateTime);
                              htmlResponsesTable += '<tr>';
                              htmlResponsesTable += '<td>'+i+' </td>';
                              htmlResponsesTable += '<td>'+eachRecord.name+' </td>';
                              htmlResponsesTable += '<td>'+dateTime+' </td>';
                              htmlResponsesTable += '<td><a class="btn btn-primary " href="https://llfdev1-llf1.cs74.force.com/responsepdf?Id='+eachRecord.sfid+'" target="_blank" style="color:white;"  >Preview</a> </td>';
                              htmlResponsesTable += '</tr>';
                              i++;
                          });
                          htmlResponsesTable += '</tbody>';
                    }
                    else
                    {
                      htmlResponsesTable += '<h4>No responses found !</h4>'
                    }

                    $('#responsesTable').empty();
                    $('#responsesTable').append(htmlResponsesTable);
                  //  $('#loader').addClass('hidden')
                     $('#spinner').hide();
                })
                .fail(function(jqXHR, status, error){
                  console.log('Error '+error);
                  console.log('status '+status);
                })
                //alert($(this).attr('id')+' clicked!');
              })
            }

           
        })
        .fail((jqXHR, status, error) => {
            $('#spinnerPldForm').hide();
            console.log('Error '+error);
            console.log('status '+status);
        })


        

       

        
    });
  </script>
 
     
  <div class="row mt-5">
      <div class="col-md-6 m-auto">
        <div class="card card-body">
         
          
        <h4>Hello <%= objUser.name%> </h4>
        <h5>Your email is <%= objUser.email %></h5> 
          <p>Welcome to Dashboard !</p>
  
          <br/>
          <a href="/users/logout" class="btn btn-primary">Logout</a>
        </div>
      </div>
</div>




<!-- <div id="loader" class="lds-dual-ring hidden overlay"></div> -->

<!-- <div class="row mt-5">
  <div class="col-md-6 m-auto">
    <div class="card card-body">
        <h4><center>Available PLD Forms </center></h4>
        <div  class="table-responsive">
          <div id="spinnerPldForm">
              <center> <img src="/spinner-gif-transparent-background-14.gif" />  </center>
          </div>

         <table class="table table-striped" id="pldTable">

         </table>
        </div>
    </div>
  </div>
</div> -->


   
  
<div id="responsesModal" class="modal fade bs-example-modal-lg" tabindex ="-1" role="dialog" aria-labelledby="myLargeModalLabel" >
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="createTaskModal">View Responses</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="table-responsive">
            <div id="spinner">
               <center> <img src="/spinner-gif-transparent-background-14.gif" />  </center>
            </div>
          <table id="responsesTable" class="table table-striped">

          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
        <button type="submit" id="expenseSubmitbutton"  class="btn btn-primary">Save</button>
      </div>
    </div>
  </div>
</div>